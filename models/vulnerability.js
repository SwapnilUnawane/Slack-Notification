const mysql = require('mysql2/promise');
const config = require('../config/config.json');

const db = mysql.createPool({
  host: config.db.host,
  user: config.db.user,
  password: config.db.password,
  database: config.db.database,
});

const createTable = async () => {
  const createVulnTable = `
    CREATE TABLE IF NOT EXISTS vulnerabilities (
      id VARCHAR(255) PRIMARY KEY,
      description TEXT,
      severity VARCHAR(50),
      datePublished DATETIME,
      notified BOOLEAN DEFAULT FALSE
    )
  `;
  await db.query(createVulnTable);
};

const insertVulnerability = async (vuln) => {
  const query = `
    INSERT INTO vulnerabilities (id, description, severity, datePublished)
    VALUES (?, ?, ?, ?)
    ON DUPLICATE KEY UPDATE notified = FALSE
  `;
  await db.query(query, [vuln.id, vuln.description, vuln.severity, vuln.datePublished]);
};

const fetchNewVulnerabilities = async () => {
  const [rows] = await db.query('SELECT * FROM vulnerabilities WHERE notified = FALSE');
  return rows;
};

const markAsNotified = async (id) => {
  const query = 'UPDATE vulnerabilities SET notified = TRUE WHERE id = ?';
  await db.query(query, [id]);
};

module.exports = {
  createTable,
  insertVulnerability,
  fetchNewVulnerabilities,
  markAsNotified,
};
